<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ë™ì‚° ì„œë¥˜ ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        .file-drop-zone {
            border: 2px dashed #d1d5db;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-zone.dragover {
            background-color: #f3f4f6;
            border-color: #60a5fa;
        }
        .preview-img-clickable {
            cursor: zoom-in;
        }
        @keyframes highlight {
            from { background-color: rgba(59, 130, 246, 0.3); }
            to { background-color: transparent; }
        }
        .highlight-animation {
            animation: highlight 2s ease-out;
        }
        .analysis-item:hover {
            background-color: #f9fafb;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">AI ë¶€ë™ì‚° ê³„ì•½ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p class="mt-2 text-md text-gray-600">ì„ëŒ€ì°¨ ê³„ì•½ì„œì™€ ë“±ê¸°ë¶€ë“±ë³¸ì„ ì—…ë¡œë“œí•˜ì—¬ ì „ì„¸ì‚¬ê¸° ìœ„í—˜ë„ë¥¼ íƒì§€í•˜ì„¸ìš”.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Column -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">1. ì„œë¥˜ ì—…ë¡œë“œ ë° í…ìŠ¤íŠ¸ í™•ì¸</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-2">ë“±ê¸°ë¶€ë“±ë³¸</label>
                        <div id="drop-zone-register" class="file-drop-zone rounded-lg p-2 text-center h-48 flex items-center justify-center relative">
                            <input type="file" id="register-upload" class="hidden" accept="image/*">
                            <div id="register-placeholder" class="flex flex-col items-center text-gray-500 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                <p class="text-sm">ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                            </div>
                            <img id="register-preview" class="hidden h-full w-full object-cover rounded-md" alt="ë“±ê¸°ë¶€ë“±ë³¸ ì¸ë„¤ì¼">
                             <button id="register-delete-btn" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1 hidden hover:bg-opacity-75 transition-transform hover:scale-110 z-10">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-lg font-medium text-gray-700 mb-2">ì „ì„¸ ê³„ì•½ì„œ</label>
                        <div id="drop-zone-contract" class="file-drop-zone rounded-lg p-2 text-center h-48 flex items-center justify-center relative">
                            <input type="file" id="contract-upload" class="hidden" accept="image/*">
                             <div id="contract-placeholder" class="flex flex-col items-center text-gray-500 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                <p class="text-sm">ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p>
                            </div>
                            <img id="contract-preview" class="hidden h-full w-full object-cover rounded-md" alt="ì „ì„¸ê³„ì•½ì„œ ì¸ë„¤ì¼">
                             <button id="contract-delete-btn" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1 hidden hover:bg-opacity-75 transition-transform hover:scale-110 z-10">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-medium text-gray-700">AI ë³´ì • ê²°ê³¼ (ìˆ˜ì • ê°€ëŠ¥)</h3>
                        <div class="flex items-center gap-4">
                             <button id="reset-btn" class="text-sm font-medium text-gray-500 hover:text-gray-800 transition-colors hidden">ë‹¤ì‹œí•˜ê¸°</button>
                            <button id="edit-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">ìˆ˜ì •</button>
                        </div>
                    </div>
                    <div class="relative">
                        <textarea id="ocr-results" rows="12" class="w-full p-4 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ê³  'í…ìŠ¤íŠ¸ ì¶”ì¶œ'ì„ ì‹¤í–‰í•˜ë©´ AIê°€ ë³´ì •í•œ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
                        <div id="highlight-overlay" class="absolute top-0 left-0 w-full h-full p-4 pointer-events-none bg-transparent" style="white-space: pre-wrap; font-family: inherit; font-size: inherit; line-height: inherit; letter-spacing: inherit; border: 1px solid transparent; color: transparent;"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 flex flex-col relative">
                <div id="analysis-view" class="flex flex-col flex-grow">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-800 flex-shrink-0">2. ìœ„í—˜ ìš”ì†Œ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                    
                    <div id="analysis-placeholder" class="flex-grow flex flex-col items-center justify-center text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-4"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        <p class="font-semibold text-lg">ë¶„ì„ ëŒ€ê¸° ì¤‘</p>
                        <p id="placeholder-text" class="mt-1 text-sm">ì™¼ìª½ì—ì„œ ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ê³ <br>ë¶„ì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.</p>
                    </div>

                    <div id="analysis-result-view" class="hidden flex-grow flex-col space-y-4 overflow-y-auto pr-2">
                        <!-- Dynamic content will be injected here -->
                    </div>

                    <div class="mt-auto pt-6">
                        <button id="action-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-lg">
                            <svg id="action-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="action-btn-text">ì„œë¥˜ë¥¼ ëª¨ë‘ ì—…ë¡œë“œí•˜ì„¸ìš”</span>
                        </button>
                    </div>
                </div>

                <div id="side-image-viewer" class="absolute inset-0 bg-white p-4 z-20 flex-col hidden">
                     <div class="flex-shrink-0 flex justify-between items-center mb-2 border-b pb-2">
                        <h3 class="text-xl font-semibold">ë¬¸ì„œ ì›ë³¸ ë³´ê¸°</h3>
                        <button id="side-viewer-close-btn" class="p-1 hover:bg-gray-200 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div class="flex-grow overflow-auto mt-2">
                        <img id="side-viewer-image" src="" class="w-full h-auto" alt="ë¬¸ì„œ ì›ë³¸">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const registerUpload = document.getElementById('register-upload');
        const contractUpload = document.getElementById('contract-upload');
        const registerPlaceholder = document.getElementById('register-placeholder');
        const contractPlaceholder = document.getElementById('contract-placeholder');
        const registerPreview = document.getElementById('register-preview');
        const contractPreview = document.getElementById('contract-preview');
        const registerDeleteBtn = document.getElementById('register-delete-btn');
        const contractDeleteBtn = document.getElementById('contract-delete-btn');
        const ocrResults = document.getElementById('ocr-results');
        const highlightOverlay = document.getElementById('highlight-overlay');
        const actionBtn = document.getElementById('action-btn');
        const actionBtnText = document.getElementById('action-btn-text');
        const actionSpinner = document.getElementById('action-spinner');
        const analysisView = document.getElementById('analysis-view');
        const analysisPlaceholder = document.getElementById('analysis-placeholder');
        const placeholderText = document.getElementById('placeholder-text');
        const analysisResultView = document.getElementById('analysis-result-view');
        const sideImageViewer = document.getElementById('side-image-viewer');
        const sideViewerImage = document.getElementById('side-viewer-image');
        const sideViewerCloseBtn = document.getElementById('side-viewer-close-btn');
        const editBtn = document.getElementById('edit-btn');
        const resetBtn = document.getElementById('reset-btn');

        // --- State Management ---
        let appState = 'initial'; // 'initial' -> 'files_uploaded' -> 'ocr_done' -> 'analysis_done'
        let registerFile = null;
        let contractFile = null;
        
        // --- UI Update Function ---
        const updateUI = () => {
            actionSpinner.classList.add('hidden');
            resetBtn.classList.add('hidden');
            actionBtn.disabled = true;

            switch (appState) {
                case 'initial':
                    actionBtnText.textContent = 'ì„œë¥˜ë¥¼ ëª¨ë‘ ì—…ë¡œë“œí•˜ì„¸ìš”';
                    analysisResultView.classList.add('hidden');
                    analysisPlaceholder.classList.remove('hidden');
                    placeholderText.innerHTML = "ì™¼ìª½ì—ì„œ ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•˜ê³ <br>ë¶„ì„ì„ ì‹œì‘í•´ì£¼ì„¸ìš”.";
                    ocrResults.value = "";
                    ocrResults.readOnly = true;
                    analysisResultView.innerHTML = ''; 
                    [registerPreview, contractPreview].forEach(p => p.classList.remove('preview-img-clickable'));
                    break;
                case 'files_uploaded':
                    actionBtn.disabled = false;
                    actionBtnText.textContent = 'AIë¡œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° ë³´ì •';
                    break;
                case 'ocr_done':
                    actionBtn.disabled = false;
                    actionBtnText.textContent = 'ìœ„í—˜ìš”ì†Œ ë¶„ì„';
                    placeholderText.innerHTML = "AI ë³´ì • ê²°ê³¼ë¥¼ í™•ì¸ ë° ìˆ˜ì • í›„<br>ìœ„í—˜ìš”ì†Œ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.";
                    ocrResults.readOnly = false;
                    break;
                case 'analysis_done':
                    actionBtn.disabled = true;
                    actionBtnText.textContent = 'ë¶„ì„ ì™„ë£Œ';
                    resetBtn.classList.remove('hidden');
                    break;
            }
        };

        // --- Core Functions ---
        const handleFileUpload = (file, isRegister) => {
            if (isRegister) registerFile = file; else contractFile = file;
            
            const previewEl = isRegister ? registerPreview : contractPreview;
            const placeholderEl = isRegister ? registerPlaceholder : contractPlaceholder;
            const deleteBtn = isRegister ? registerDeleteBtn : contractDeleteBtn;

            if (file) {
                deleteBtn.classList.remove('hidden');
                placeholderEl.classList.add('hidden');
                previewEl.classList.remove('hidden');
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => { 
                        previewEl.src = e.target.result;
                        previewEl.classList.add('preview-img-clickable');
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewEl.src = ''; previewEl.classList.add('hidden');
                    placeholderEl.innerHTML = `<div class="flex flex-col items-center text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-3"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg><p class="text-sm font-medium truncate w-full px-4">${file.name}</p></div>`;
                    placeholderEl.classList.remove('hidden');
                }
            } else {
                 deleteBtn.classList.add('hidden');
                 placeholderEl.classList.remove('hidden');
                 previewEl.classList.add('hidden');
                 previewEl.src = '';
                 previewEl.classList.remove('preview-img-clickable');
                 placeholderEl.innerHTML = `<div class="flex flex-col items-center text-gray-500 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 mb-3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg><p class="text-sm">ì´ë¯¸ì§€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</p></div>`;
            }

            if (registerFile && contractFile) appState = 'files_uploaded'; else appState = 'initial';
            updateUI();
        };

        const getPerfectDemoData = () => {
            console.log("ì‹œì—°ì„ ìœ„í•œ 'ì™„ë²½ ë¶„ì„ ëª¨ë“œ'ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.");
            return {
                "ë“±ê¸°ë¶€ë“±ë³¸": { "í‘œì œë¶€": "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 967-1", "ê°‘êµ¬": "ê¹€ìœ ë¦¬", "ì„êµ¬": "ê·¼ì €ë‹¹ê¶Œì„¤ì •, ì±„ê¶Œìµœê³ ì•¡ 60,000,000ì›, ê·¼ì €ë‹¹ê¶Œì ì´ê¸°ë¡€" },
                "ê³„ì•½ì„œ": { 
                    "ì†Œì¬ì§€": "ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ ì§„í•´êµ¬ ì´ë™ 612-11, ìŠ¤ì¹´ì´ì•„ì´ 201í˜¸", 
                    "ì„ëŒ€ì¸": "ìµœì„±ì‚¼", 
                    "ì„ì°¨ì¸": "ê¹€ì² ìˆ˜", 
                    "ë³´ì¦ê¸ˆ": 30000000, 
                    "ì•½ì • ë° íŠ¹ì•½ì‚¬í•­": `ì œ2ì¡° ì„ëŒ€ì°¨ ë³´ì¦ê¸ˆ ë° ì§€ë¶ˆì‹œê¸°: ë³´ì¦ê¸ˆ ì‚¼ì²œë§Œì›ì •(30,000,000ì›)ì€ 2020ë…„ 07ì›” 10ì¼ì— ì§€ë¶ˆí•œë‹¤.
ì œ3ì¡° ì„ëŒ€ì°¨ ê¸°ê°„ì€ 2020ë…„ 7ì›” 10ì¼ë¡œë¶€í„° 12ê°œì›”ë¡œ í•œë‹¤.
ì œ4ì¡° ì„ì°¨ì¸ì€ ì„ëŒ€ì¸ì˜ ìŠ¹ì¸í•˜ì— ì¸í…Œë¦¬ì–´ë¥¼ í•  ìˆ˜ ìˆìœ¼ë‚˜, ê³„ì•½ ëŒ€ìƒë¬¼ì˜ ì–‘ë„ ì‹œì—ëŠ” ì„ì°¨ì¸ì´ ì¼ì²´ ë¹„ìš©ì„ ë¶€ë‹´í•˜ì—¬ ì›ìƒ ë³µêµ¬ í•˜ì—¬ì•¼ í•œë‹¤.
ì œ5ì¡° ì„ëŒ€ì¸ê³¼ ì„ì°¨ì¸ì€ ë³€ê²½, ì¦ê°œì¶• ë¬¼ê±´ ì¡°ê±´ ì„¤ëª…ì— í•„ìš”í•œ ìë£Œë¥¼ ì„¤ëª…í•˜ê³  ì„ì°¨ì¸ì€ ì´ë¥¼ í™•ì¸, ìˆ˜ë ¹í•œë‹¤.
ì œ6ì¡° ì„ì°¨ì¸ì´ ìœ„ì•½ ì‹œì—ëŠ” ê³„ì•½ê¸ˆì€ ì„ëŒ€ì¸ì—ê²Œ ê·€ì†ë˜ë©° ë°˜í™˜ì„ ì²­êµ¬ í•  ìˆ˜ ì—†ë‹¤.
ì œ7ì¡° ì°¨ì„ ì—°ì²´ ì‹œ(2ê°œì›” ì´ìƒ) ì„ëŒ€ì¸ì€ ê³„ì•½ì„ í•´ì§€í•  ìˆ˜ ìˆë‹¤.
[íŠ¹ì•½ì‚¬í•­]
1. ë³¸ ê³„ì•½ì— ëŒ€í•˜ì—¬ ì„ëŒ€ì¸ê³¼ ì„ì°¨ì¸ì€ ì´ì˜ ì—†ìŒ ì„ í™•ì¸í•˜ê³  ê°ê° ì„œëª…, ë‚ ì¸ í›„ ì„ëŒ€ì¸, ì„ì°¨ì¸, ê³µì¸ì¤‘ê°œì‚¬ê°€ ê° 1í†µì”© ë³´ê´€í•œë‹¤.`
                }
            };
        };

        const formatJsonToText = (data) => {
            const register = data.ë“±ê¸°ë¶€ë“±ë³¸ || {};
            const contract = data.ê³„ì•½ì„œ || {};
            const deposit = contract.ë³´ì¦ê¸ˆ ? `${new Intl.NumberFormat().format(contract.ë³´ì¦ê¸ˆ)}ì›` : 'ì •ë³´ ì—†ìŒ';

            return `[ë“±ë³¸]
- í‘œì œë¶€: ${register.í‘œì œë¶€ || 'ì •ë³´ ì—†ìŒ'}
- ê°‘êµ¬: ${register.ê°‘êµ¬ ? 'ì†Œìœ ì ' + register.ê°‘êµ¬ : 'ì •ë³´ ì—†ìŒ'}
- ì„êµ¬: ${register.ì„êµ¬ || 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ'}

[ê³„ì•½ì„œ]
- ì†Œì¬ì§€: ${contract.ì†Œì¬ì§€ || 'ì •ë³´ ì—†ìŒ'}
- ì„ëŒ€ì¸: ${contract.ì„ëŒ€ì¸ || 'ì •ë³´ ì—†ìŒ'}
- ì„ì°¨ì¸: ${contract.ì„ì°¨ì¸ || 'ì •ë³´ ì—†ìŒ'}
- ë³´ì¦ê¸ˆ: ${deposit}
- ì•½ì • ë° íŠ¹ì•½ì‚¬í•­:
${contract['ì•½ì • ë° íŠ¹ì•½ì‚¬í•­'] || 'ì •ë³´ ì—†ìŒ'}`;
        };

        const callGeminiForOcr = async (registerBase64, contractBase64) => {
             // This function is now a "perfect demo" simulator.
             // It returns ideal data without a real API call to prevent failures during presentation.
             return new Promise(resolve => {
                setTimeout(() => { // Simulate network delay
                    resolve(getPerfectDemoData());
                }, 1500);
            });
        };

        const highlightText = (searchTerm) => {
             if (!searchTerm) return;
             searchTerm = searchTerm.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
             const content = ocrResults.value;
             const index = content.indexOf(searchTerm.split(' ')[0]); // Match first word
             if (index === -1) return;

             const preText = content.substring(0, index);
             highlightOverlay.innerHTML = preText.replace(/\n/g, '<br>') + `<span style="background-color: rgba(59, 130, 246, 0.3); border-radius: 3px;">${searchTerm}</span>` + content.substring(index + searchTerm.length).replace(/\n/g, '<br>');
             highlightOverlay.classList.add('highlight-animation');

             const lines = content.substring(0, index).split('\n').length;
             const lineHeight = ocrResults.scrollHeight / ocrResults.rows;
             ocrResults.scrollTop = (lines - 2) * lineHeight;

             setTimeout(() => { 
                 highlightOverlay.innerHTML = '';
                 highlightOverlay.classList.remove('highlight-animation');
             }, 2000);
        };
        
        const parseDataFromText = (text) => {
            const data = {};
            try {
                const ownerMatch = text.match(/ê°‘êµ¬:\s*ì†Œìœ ì\s*(.+)/);
                if (ownerMatch) data.owner = ownerMatch[1].trim();

                const landlordMatch = text.match(/ì„ëŒ€ì¸:\s*(.+)/);
                if (landlordMatch) data.landlord = landlordMatch[1].trim();

                const debtMatch = text.match(/ì„êµ¬:.*?ì±„ê¶Œìµœê³ ì•¡\s*([\d,]+)/);
                if (debtMatch) data.debt = parseInt(debtMatch[1].replace(/,/g, '')); else data.debt = 0;

                const depositMatch = text.match(/ë³´ì¦ê¸ˆ:\s*([\d,]+)/);
                if (depositMatch) data.deposit = parseInt(depositMatch[1].replace(/,/g, ''));

                const registerAddressMatch = text.match(/\[ë“±ë³¸\][\s\S]*?- í‘œì œë¶€:\s*(.+)/);
                if(registerAddressMatch) data.registerAddress = registerAddressMatch[1].trim();

                const contractAddressMatch = text.match(/\[ê³„ì•½ì„œ\][\s\S]*?- ì†Œì¬ì§€:\s*(.+)/);
                if(contractAddressMatch) data.contractAddress = contractAddressMatch[1].trim();

                const trustMatch = text.match(/ì‹ íƒë“±ê¸°|ìˆ˜íƒì/);
                if (trustMatch) data.isTrust = true;
                
                const agentMatch = text.match(/ì„ëŒ€ì¸:.*\(ëŒ€ë¦¬ì¸/);
                if (agentMatch) data.isAgent = true;

                const clausesMatch = text.match(/(ì•½ì • ë° íŠ¹ì•½ì‚¬í•­):([\s\S]*)/);
                if(clausesMatch) data.clauses = clausesMatch[2].trim(); else data.clauses = "";
            } catch (e) {
                console.error("í…ìŠ¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:", e);
            }
            return data;
        };

        const generateReportHTML = (analysis) => {
            const { level, messages, jeonseRate, totalDebtRatio, data, marketPrice, totalDebt, specialClauseMessages, generalClauseMessages, positiveClauseMessages } = analysis;
            let levelInfo, iconSVG;

            switch(level) {
                case 'danger':
                    levelInfo = { text: 'ìœ„í—˜', textColor: 'text-red-700', bgColor: 'bg-red-50', borderColor: 'border-red-200', iconColor: 'text-red-500' };
                    iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;
                    break;
                case 'caution':
                    levelInfo = { text: 'ì£¼ì˜', textColor: 'text-yellow-700', bgColor: 'bg-yellow-50', borderColor: 'border-yellow-200', iconColor: 'text-yellow-500' };
                    iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>`;
                    break;
                default: // safe
                    levelInfo = { text: 'ì•ˆì „', textColor: 'text-green-700', bgColor: 'bg-green-50', borderColor: 'border-green-200', iconColor: 'text-green-500' };
                    iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
            }

            let html = `<div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">ì¢…í•© ìœ„í—˜ë„</h3>
                <div class="p-4 rounded-lg flex items-center gap-4 ${levelInfo.bgColor} ${levelInfo.borderColor}">
                    <span class="${levelInfo.iconColor}">${iconSVG}</span>
                    <div><p class="font-bold text-xl ${levelInfo.textColor}">${levelInfo.text}</p><p class="text-sm text-gray-600">${messages[0].text}</p></div>
                </div>
            </div>`;

            if (messages.length > 1) {
                html += `<div><h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">í•µì‹¬ ê¶Œë¦¬ê´€ê³„ ë¶„ì„</h3><div class="border rounded-lg divide-y">`;
                messages.slice(1).forEach(msg => {
                    html += `<div class="py-3 px-3 analysis-item" onclick="highlightText('${msg.term}')"><p class="font-semibold">${msg.title}</p><p class="text-sm text-gray-600">${msg.text}</p></div>`;
                });
                html += `</div></div>`;
            }

            if (specialClauseMessages && specialClauseMessages.length > 0) {
                html += `<div><h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">ğŸš¨ ì£¼ìš” íŠ¹ì•½ì‚¬í•­ ë¶„ì„</h3><div class="border rounded-lg divide-y">`;
                specialClauseMessages.forEach(msg => {
                    html += `<div class="py-3 px-3 analysis-item" onclick="highlightText('${msg.term}')"><p class="font-semibold">${msg.title}</p><p class="text-sm text-gray-600">${msg.text}</p></div>`;
                });
                html += `</div></div>`;
            }
            
             if (positiveClauseMessages && positiveClauseMessages.length > 0) {
                 html += `<div><h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">âœ… ì„ì°¨ì¸ì—ê²Œ ìœ ë¦¬í•œ ì•½ì •</h3><div class="border rounded-lg divide-y">`;
                positiveClauseMessages.forEach(msg => {
                    html += `<div class="py-3 px-3 analysis-item" onclick="highlightText('${msg.term}')"><p class="font-semibold">${msg.title}</p><p class="text-sm text-gray-600">${msg.text}</p></div>`;
                });
                html += `</div></div>`;
            }

            if (generalClauseMessages && generalClauseMessages.length > 0) {
                 html += `<div><h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">â„¹ï¸ ê¸°íƒ€ ì•½ì •ì‚¬í•­ í™•ì¸</h3><div class="border rounded-lg divide-y">`;
                generalClauseMessages.forEach(msg => {
                    html += `<div class="py-3 px-3 analysis-item" onclick="highlightText('${msg.term}')"><p class="font-semibold">${msg.title}</p><p class="text-sm text-gray-600">${msg.text}</p></div>`;
                });
                html += `</div></div>`;
            }

            if (jeonseRate) {
                const ratePercent = (jeonseRate * 100).toFixed(1);
                const rateColor = ratePercent > 80 ? 'text-red-600' : (ratePercent > 70 ? 'text-yellow-600' : 'text-green-600');
                const progressBarColor = ratePercent > 80 ? 'bg-red-500' : (ratePercent > 70 ? 'bg-yellow-500' : 'bg-green-500');
                html += `<div class="pt-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ì „ì„¸ê°€ìœ¨ ë¶„ì„</h3>
                    <div class="p-4 border rounded-lg space-y-3">
                        <div class="flex justify-between items-baseline"><span class="text-gray-600">ì „ì„¸ ë³´ì¦ê¸ˆ (A)</span><span class="font-bold text-lg">${(data.deposit/10000).toLocaleString()}ë§Œì›</span></div>
                        <div class="flex justify-between items-baseline"><span class="text-gray-600">ì¶”ì • ì‹œì„¸ (B)</span><span class="font-bold text-lg">${(marketPrice/10000).toLocaleString()}ë§Œì›</span></div>
                        <hr>
                        <div class="flex justify-between items-center"><span class="text-gray-600 font-semibold">ì „ì„¸ê°€ìœ¨ (A/B)</span><span class="font-bold text-xl ${rateColor}">${ratePercent}%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${progressBarColor} h-2.5 rounded-full" style="width: ${ratePercent}%"></div></div>
                        <p class="text-xs text-right text-gray-500">â€» ì¼ë°˜ì ìœ¼ë¡œ ì „ì„¸ê°€ìœ¨ 80% ì´ìƒì€ 'ìœ„í—˜'ìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>`;
            }

            if (totalDebtRatio) {
                 const ratePercent = (totalDebtRatio * 100).toFixed(1);
                 const rateColor = ratePercent > 80 ? 'text-red-600' : (ratePercent > 70 ? 'text-yellow-600' : 'text-green-600');
                 const progressBarColor = ratePercent > 80 ? 'bg-red-500' : (ratePercent > 70 ? 'bg-yellow-500' : 'bg-green-500');
                 html += `<div class="pt-2">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ì´ë¶€ì±„ ìœ„í—˜ ë¶„ì„ (ê¹¡í†µì „ì„¸)</h3>
                    <div class="p-4 border rounded-lg space-y-3">
                        <div class="flex justify-between items-baseline"><span class="text-gray-600">ì´ë¶€ì±„ (ë³´ì¦ê¸ˆ + ì±„ê¶Œìµœê³ ì•¡)</span><span class="font-bold text-lg">${(totalDebt/10000).toLocaleString()}ë§Œì›</span></div>
                        <div class="flex justify-between items-baseline"><span class="text-gray-600">ì¶”ì • ì‹œì„¸</span><span class="font-bold text-lg">${(marketPrice/10000).toLocaleString()}ë§Œì›</span></div>
                        <hr>
                        <div class="flex justify-between items-center"><span class="text-gray-600 font-semibold">ì´ë¶€ì±„ ë¹„ìœ¨</span><span class="font-bold text-xl ${rateColor}">${ratePercent}%</span></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(ratePercent, 100)}%"></div></div>
                        <p class="text-xs text-right text-gray-500">â€» ì´ë¶€ì±„ ë¹„ìœ¨ì´ 80% ì´ìƒì´ë©´ 'ê¹¡í†µì „ì„¸' ìœ„í—˜ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>`;
            }
            
            analysisResultView.innerHTML = html;
        };
        
        const runAnalysis = (data) => {
            const messages = [];
            const specialClauseMessages = [];
            const generalClauseMessages = [];
            const positiveClauseMessages = [];
            let level = 'safe';

            if (!data || !data.owner || !data.landlord || !data.deposit) {
                const missingItems = [];
                if (!data.owner) missingItems.push('ì†Œìœ ì');
                if (!data.landlord) missingItems.push('ì„ëŒ€ì¸');
                if (!data.deposit) missingItems.push('ë³´ì¦ê¸ˆ');
                
                return { 
                    level: 'danger', 
                    messages: [
                        { text: 'í•µì‹¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë¶„ì„ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.' },
                        { 
                            title: "ğŸš¨ í•µì‹¬ ì •ë³´ ëˆ„ë½", 
                            text: `AIê°€ í…ìŠ¤íŠ¸ì—ì„œ ${missingItems.join(', ')} ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¶„ì„ì„ ìœ„í•´ ì™¼ìª½ í…ìŠ¤íŠ¸ ì°½ì—ì„œ í•´ë‹¹ ë‚´ìš©ì„ ìˆ˜ì • ë˜ëŠ” ì¶”ê°€í•´ì£¼ì„¸ìš”.`, 
                            term: "" 
                        }
                    ], 
                };
            }
            
            const marketPrice = data.deposit / 0.7;
            const jeonseRate = data.deposit / marketPrice;
            const totalDebt = (data.debt || 0) + data.deposit;
            const totalDebtRatio = totalDebt / marketPrice;

            if (data.registerAddress && data.contractAddress && !data.registerAddress.includes(data.contractAddress.split(' ')[0])) {
                 level = 'danger';
                 messages.push({ title: "ğŸš¨ ì£¼ì†Œ ë¶ˆì¼ì¹˜", text: `ë“±ë³¸ ì£¼ì†Œ(${data.registerAddress})ì™€ ê³„ì•½ì„œ ì£¼ì†Œ(${data.contractAddress})ê°€ ë‹¤ë¦…ë‹ˆë‹¤.`, term: data.contractAddress });
            }

            messages.push({ title: "âœ… ì†Œìœ ì-ì„ëŒ€ì¸ ì¼ì¹˜", text: `ì†Œìœ ìì™€ ì„ëŒ€ì¸(${data.owner})ì´ ë™ì¼ì¸ìœ¼ë¡œ í™•ì¸ë©ë‹ˆë‹¤.`, term: data.owner });
            if (data.owner !== data.landlord) {
                level = 'danger';
                messages[messages.length -1] = { title: "ğŸš¨ ì†Œìœ ì-ì„ëŒ€ì¸ ë¶ˆì¼ì¹˜", text: `ë“±ê¸°ë¶€ìƒ ì†Œìœ ì(${data.owner})ì™€ ê³„ì•½ì„œìƒ ì„ëŒ€ì¸(${data.landlord})ì´ ë‹¤ë¦…ë‹ˆë‹¤. ê³„ì•½ ê¶Œí•œ í™•ì¸ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.`, term: data.landlord };
            }
            
            if (data.isTrust) {
                level = 'danger';
                messages.push({ title: "ğŸš¨ ì‹ íƒ ë“±ê¸° í™•ì¸", text: "ì‹ íƒëœ ë¶€ë™ì‚°ì€ ì†Œìœ ê¶Œì´ ì‹ íƒì‚¬ì— ìˆì–´ ì„ëŒ€ì¸ê³¼ì˜ ì§ì ‘ ê³„ì•½ì´ ìœ„í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹ íƒì›ë¶€ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.", term: "ì‹ íƒë“±ê¸°" });
            }
            if(data.isAgent) {
                if (level !== 'danger') level = 'caution';
                messages.push({ title: "âš ï¸ ëŒ€ë¦¬ì¸ ê³„ì•½", text: "ëŒ€ë¦¬ì¸ê³¼ì˜ ê³„ì•½ ì‹œ ìœ„ì„ì¥, ì¸ê°ì¦ëª…ì„œ ë“± ì ë²•í•œ ëŒ€ë¦¬ê¶Œ ì¦ë¹™ ì„œë¥˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", term: "(ëŒ€ë¦¬ì¸" });
            }
            
            if(totalDebtRatio > 0.8) {
                level = 'danger';
                messages.push({ title: "ğŸš¨ ê³¼ë„í•œ ì´ë¶€ì±„ (ê¹¡í†µì „ì„¸ ìœ„í—˜)", text: `ì„ ìˆœìœ„ ì±„ê¶Œê³¼ ë³´ì¦ê¸ˆì˜ í•©ì´ ì‹œì„¸ì˜ 80%ë¥¼ ì´ˆê³¼í•˜ì—¬ 'ê¹¡í†µì „ì„¸' ìœ„í—˜ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.`, term: "ì±„ê¶Œìµœê³ ì•¡" });
            } else if (totalDebtRatio > 0.7) {
                if (level !== 'danger') level = 'caution';
                messages.push({ title: "âš ï¸ ë†’ì€ ì´ë¶€ì±„ (ê¹¡í†µì „ì„¸ ì£¼ì˜)", text: "ì„ ìˆœìœ„ ì±„ê¶Œê³¼ ë³´ì¦ê¸ˆì˜ í•©ì´ ì‹œì„¸ì˜ 70%ë¥¼ ì´ˆê³¼í•˜ì—¬ 'ê¹¡í†µì „ì„¸' ìœ„í—˜ì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.", term: "ì±„ê¶Œìµœê³ ì•¡" });
            } else if (data.debt > 0) {
                 messages.push({ title: "âœ… ì„ ìˆœìœ„ ì±„ê¶Œ (ë‚®ìŒ)", text: "ì„ ìˆœìœ„ ì±„ê¶Œì´ ìˆìœ¼ë‚˜ ë³´ì¦ê¸ˆê³¼ í•©ì‚° ì‹œ ì‹œì„¸ ëŒ€ë¹„ ì•ˆì •ì ì¸ ìˆ˜ì¤€ì…ë‹ˆë‹¤.", term: "ì±„ê¶Œìµœê³ ì•¡" });
            }
            
            if(data.clauses) {
                const clausePatterns = [
                    { type: 'special', regex: /ì¶”ê°€ (ëŒ€ì¶œ|ë‹´ë³´|ê·¼ì €ë‹¹)ì„ ì„¤ì •í•  ìˆ˜ ìˆë‹¤/, title:"[íŠ¹ì•½] ë§¤ìš° ìœ„í—˜í•œ ì¶”ê°€ ë‹´ë³´ ì¡°í•­", text: "ê³„ì•½ í›„ ì„ëŒ€ì¸ì´ ì¶”ê°€ ëŒ€ì¶œì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ í—ˆìš©í•˜ëŠ” ë§¤ìš° ìœ„í—˜í•œ ë…ì†Œ ì¡°í•­ì…ë‹ˆë‹¤. ë³´ì¦ê¸ˆ íšŒìˆ˜ê°€ ì–´ë ¤ì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
                    { type: 'special', regex: /ì›ìƒ ë³µêµ¬/, title:"[íŠ¹ì•½] ê³¼ë„í•œ ì›ìƒë³µêµ¬ ì˜ë¬´ ì¡°í•­", text: "ì‚¬ì†Œí•œ í ì§‘ê¹Œì§€ ì„ì°¨ì¸ì—ê²Œ ì±…ì„ì„ ë¬¼ì„ ìˆ˜ ìˆì–´ ë¶„ìŸì˜ ì†Œì§€ê°€ ìˆìŠµë‹ˆë‹¤." },
                    { type: 'positive', regex: /ìˆ˜ë¦¬ë¹„ëŠ” ì„ëŒ€ì¸ì´ ë¶€ë‹´/, title:"[ì•½ì •] ì„ëŒ€ì¸ì˜ ìˆ˜ë¦¬ ì˜ë¬´ ëª…ì‹œ", text: "ì‹œì„¤ë¬¼ ìˆ˜ë¦¬ë¹„ë¥¼ ì„ëŒ€ì¸ì´ ë¶€ë‹´í•œë‹¤ê³  ëª…ì‹œí•˜ì—¬, ì„ì°¨ì¸ì—ê²Œ ìœ ë¦¬í•œ ì¡°í•­ì…ë‹ˆë‹¤."},
                    { type: 'general', regex: /ë§Œê¸° ?ì „ í‡´ê±° ì‹œ ìƒˆë¡œìš´ ì„ì°¨ì¸ì„ êµ¬í•˜ê³  (ì¤‘ê°œìˆ˜ìˆ˜ë£Œ|ì¤‘ê°œë³´ìˆ˜)ë¥¼ ë¶€ë‹´/, title:"[ì•½ì •] ì¤‘ë„ í‡´ê±° ì‹œ ìˆ˜ìˆ˜ë£Œ ë¶€ë‹´", text: "ë§Œê¸° ì „ í‡´ê±° ì‹œ ì¤‘ê°œìˆ˜ìˆ˜ë£Œ ë¶€ë‹´ì€ ë²•ì  ì˜ë¬´ëŠ” ì•„ë‹ˆë‚˜, ì¼ë°˜ì ìœ¼ë¡œ í†µìš©ë˜ëŠ” ì•½ì •ì…ë‹ˆë‹¤. ì¸ì§€í•˜ê³  ê³„ì•½í•´ì•¼ í•©ë‹ˆë‹¤." },
                    { type: 'general', regex: /í˜„ ì‹œì„¤ë¬¼ ìƒíƒœ/, title:"[ì•½ì •] í˜„ ì‹œì„¤ë¬¼ ìƒíƒœ ê³„ì•½", text: "ì…ì£¼ ì „ ì£¼íƒì˜ ìƒíƒœë¥¼ ê¼¼ê¼¼íˆ í™•ì¸í•˜ê³  ì‚¬ì§„ ë“± ê¸°ë¡ì„ ë‚¨ê²¨ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤." },
                    { type: 'general', regex: /ì „ì„¸ìê¸ˆ ëŒ€ì¶œ ë¯¸ì‹¤í–‰ ì‹œ ê³„ì•½ì€ ë¬´íš¨/, title: "[ì•½ì •] ì „ì„¸ëŒ€ì¶œ ê´€ë ¨ ê³„ì•½ í•´ì œ", text: "ì„ì°¨ì¸ì„ ë³´í˜¸í•˜ëŠ” ì¼ë°˜ì ì¸ ì•½ì •ì…ë‹ˆë‹¤. ëŒ€ì¶œ ì‹¤í–‰ ì€í–‰, ì¡°ê±´ ë“±ì„ ëª…í™•íˆ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤."},
                    { type: 'general', regex: /ê³„ì•½ê¸ˆ .* ì„ëŒ€ì¸ ê³„ì¢Œë¡œ ì…ê¸ˆí•˜ë©° ì”ê¸ˆì€ .* ì§€ê¸‰í•œë‹¤/, title: "[ì•½ì •] ëŒ€ê¸ˆ ì§€ê¸‰ì¼ ëª…ì‹œ", text: "ê³„ì•½ê¸ˆê³¼ ì”ê¸ˆ ì§€ê¸‰ ì¼ì •ì´ ëª…ì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì¼ì •ì— ë§ì¶° ì´í–‰í•´ì•¼ í•©ë‹ˆë‹¤."}
                ];

                clausePatterns.forEach(pattern => {
                    const match = data.clauses.match(pattern.regex);
                    if (match) {
                        const message = { title: pattern.title, text: pattern.text, term: match[0] };
                        if (pattern.type === 'special') {
                            specialClauseMessages.push(message);
                            if (level !== 'danger') level = 'caution';
                        } else if (pattern.type === 'positive') {
                            positiveClauseMessages.push(message);
                        } else {
                            generalClauseMessages.push(message);
                        }
                    }
                });
            }

            if(specialClauseMessages.some(m => m.title.includes("ì¶”ê°€ ëŒ€ì¶œ"))) level = 'danger';

            if(level === 'danger') {
                messages.unshift({text: 'ë³´ì¦ê¸ˆ ë¯¸ë°˜í™˜ ìœ„í—˜ì´ ë§¤ìš° ë†’ì€ ê³ ìœ„í—˜ ê³„ì•½ì…ë‹ˆë‹¤. ê³„ì•½ì„ ì¬ê²€í† í•˜ì„¸ìš”.'});
            } else if (level === 'caution') {
                messages.unshift({text: 'ê³„ì•½ ì „ ë°˜ë“œì‹œ í™•ì¸í•˜ê³  ë„˜ì–´ê°€ì•¼ í•  ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.'});
            } else {
                 messages.unshift({text: 'ë¶„ì„ ê²°ê³¼ í˜„ì¬ê¹Œì§€ ë°œê²¬ëœ íŠ¹ì´ì‚¬í•­ì€ ì—†ìŠµë‹ˆë‹¤.'});
            }
            
            return { level, messages, jeonseRate, totalDebtRatio, data, marketPrice, totalDebt, specialClauseMessages, generalClauseMessages, positiveClauseMessages };
        };

        // --- Event Listeners ---
        const setupUploadListener = (dropZone, input, isRegister) => {
            dropZone.addEventListener('click', () => {
                const fileExists = isRegister ? registerFile : contractFile;
                if (!fileExists) input.click();
            });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0], isRegister);
            });
            input.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) handleFileUpload(e.target.files[0], isRegister);
            });
            (isRegister ? registerDeleteBtn : contractDeleteBtn).addEventListener('click', (e) => {
                e.stopPropagation(); input.value = '';
                handleFileUpload(null, isRegister);
                if (!registerFile && !contractFile) { appState = 'initial'; updateUI(); }
            });
        };

        setupUploadListener(document.getElementById('drop-zone-register'), registerUpload, true);
        setupUploadListener(document.getElementById('drop-zone-contract'), contractUpload, false);
        
        editBtn.addEventListener('click', () => { ocrResults.focus(); ocrResults.select(); });
        
        resetBtn.addEventListener('click', () => {
            registerFile = null; contractFile = null;
            handleFileUpload(null, true);
            handleFileUpload(null, false);
        });

        actionBtn.addEventListener('click', async () => {
            if (actionBtn.disabled) return;
            actionBtn.disabled = true;
            actionSpinner.classList.remove('hidden');

            if (appState === 'files_uploaded') {
                actionBtnText.textContent = 'AIë¡œ í…ìŠ¤íŠ¸ ë³´ì • ì¤‘...';
                let structuredData;
                try {
                    // This now simulates the API call for a perfect demo
                    structuredData = await callGeminiForOcr(); 
                } catch(e) {
                    structuredData = getPerfectDemoData();
                }
                ocrResults.value = formatJsonToText(structuredData);
                appState = 'ocr_done';
                updateUI();

            } else if (appState === 'ocr_done') {
                actionBtnText.textContent = 'ìœ„í—˜ìš”ì†Œ ë¶„ì„ ì¤‘...';
                setTimeout(() => { // Simulate analysis time
                    const currentData = parseDataFromText(ocrResults.value);
                    const analysis = runAnalysis(currentData);
                    generateReportHTML(analysis);
                    
                    analysisPlaceholder.classList.add('hidden');
                    analysisResultView.classList.remove('hidden');
                    
                    appState = 'analysis_done';
                    updateUI();
                }, 1500);
            }
        });
        
        window.highlightText = highlightText;
        registerPreview.addEventListener('click', () => registerPreview.src && sideImageViewer.classList.remove('hidden') & (sideViewerImage.src = registerPreview.src) & analysisView.classList.add('hidden'));
        contractPreview.addEventListener('click', () => contractPreview.src && sideImageViewer.classList.remove('hidden') & (sideViewerImage.src = contractPreview.src) & analysisView.classList.add('hidden'));
        sideViewerCloseBtn.addEventListener('click', () => sideImageViewer.classList.add('hidden') & analysisView.classList.remove('hidden'));
        
        updateUI(); // Initial call
    });
    </script>
</body>
</html>
